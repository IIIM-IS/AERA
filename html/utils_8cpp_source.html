<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.18"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>AERA: utils.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">AERA
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.18 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_fe6eb5064d42f9f773e90d3512fafa25.html">submodules</a></li><li class="navelem"><a class="el" href="dir_1e141255ad39831268f400e8e061c781.html">AERA</a></li><li class="navelem"><a class="el" href="dir_39fd2151bc1eca10af574fda57847c43.html">submodules</a></li><li class="navelem"><a class="el" href="dir_f651861299d1e2585cec418d4f276247.html">CoreLibrary</a></li><li class="navelem"><a class="el" href="dir_24a44c508802b8c75334d5f5953c6118.html">CoreLibrary</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">utils.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">//_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">//_/_/ AERA</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">//_/_/ Autocatalytic Endogenous Reflective Architecture</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">//_/_/ </span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment">//_/_/ Copyright (c) 2018-2025 Jeff Thompson</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">//_/_/ Copyright (c) 2018-2025 Kristinn R. Thorisson</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">//_/_/ Copyright (c) 2018-2025 Icelandic Institute for Intelligent Machines</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">//_/_/ http://www.iiim.is</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">//_/_/ </span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment">//_/_/ Copyright (c) 2010-2012 Eric Nivel, Thor List</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">//_/_/ Center for Analysis and Design of Intelligent Agents</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">//_/_/ Reykjavik University, Menntavegur 1, 102 Reykjavik, Iceland</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">//_/_/ http://cadia.ru.is</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment">//_/_/ </span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment">//_/_/ Part of this software was developed by Eric Nivel</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment">//_/_/ in the HUMANOBS EU research project, which included</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">//_/_/ the following parties:</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment">//_/_/ Autonomous Systems Laboratory</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">//_/_/ Technical University of Madrid, Spain</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">//_/_/ http://www.aslab.org/</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment">//_/_/ Communicative Machines</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">//_/_/ Edinburgh, United Kingdom</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment">//_/_/ http://www.cmlabs.com/</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment">//_/_/ Istituto Dalle Molle di Studi sull&#39;Intelligenza Artificiale</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment">//_/_/ University of Lugano and SUPSI, Switzerland</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment">//_/_/ http://www.idsia.ch/</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;<span class="comment">//_/_/ Institute of Cognitive Sciences and Technologies</span></div>
<div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;<span class="comment">//_/_/ Consiglio Nazionale delle Ricerche, Italy</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="comment">//_/_/ http://www.istc.cnr.it/</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">//_/_/ Dipartimento di Ingegneria Informatica</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment">//_/_/ University of Palermo, Italy</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment">//_/_/ http://diid.unipa.it/roboticslab/</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment">//_/_/ --- HUMANOBS Open-Source BSD License, with CADIA Clause v 1.0 ---</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;<span class="comment">//_/_/ Redistribution and use in source and binary forms, with or without</span></div>
<div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;<span class="comment">//_/_/ modification, is permitted provided that the following conditions</span></div>
<div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;<span class="comment">//_/_/ are met:</span></div>
<div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;<span class="comment">//_/_/ - Redistributions of source code must retain the above copyright</span></div>
<div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;<span class="comment">//_/_/   and collaboration notice, this list of conditions and the</span></div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;<span class="comment">//_/_/   following disclaimer.</span></div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;<span class="comment">//_/_/ - Redistributions in binary form must reproduce the above copyright</span></div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;<span class="comment">//_/_/   notice, this list of conditions and the following disclaimer </span></div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;<span class="comment">//_/_/   in the documentation and/or other materials provided with </span></div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;<span class="comment">//_/_/   the distribution.</span></div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;<span class="comment">//_/_/ - Neither the name of its copyright holders nor the names of its</span></div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;<span class="comment">//_/_/   contributors may be used to endorse or promote products</span></div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="comment">//_/_/   derived from this software without specific prior </span></div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;<span class="comment">//_/_/   written permission.</span></div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;<span class="comment">//_/_/   </span></div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;<span class="comment">//_/_/ - CADIA Clause: The license granted in and to the software </span></div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;<span class="comment">//_/_/   under this agreement is a limited-use license. </span></div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;<span class="comment">//_/_/   The software may not be used in furtherance of:</span></div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;<span class="comment">//_/_/    (i)   intentionally causing bodily injury or severe emotional </span></div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;<span class="comment">//_/_/          distress to any person;</span></div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;<span class="comment">//_/_/    (ii)  invading the personal privacy or violating the human </span></div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;<span class="comment">//_/_/          rights of any person; or</span></div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;<span class="comment">//_/_/    (iii) committing or preparing for any act of war.</span></div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;<span class="comment">//_/_/</span></div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;<span class="comment">//_/_/ THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND </span></div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;<span class="comment">//_/_/ CONTRIBUTORS &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, </span></div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;<span class="comment">//_/_/ INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF </span></div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;<span class="comment">//_/_/ MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE </span></div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;<span class="comment">//_/_/ DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR </span></div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;<span class="comment">//_/_/ CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, </span></div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;<span class="comment">//_/_/ SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, </span></div>
<div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;<span class="comment">//_/_/ BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR </span></div>
<div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;<span class="comment">//_/_/ SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS </span></div>
<div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">//_/_/ INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, </span></div>
<div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment">//_/_/ WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING </span></div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment">//_/_/ NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE </span></div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;<span class="comment">//_/_/ OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY </span></div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;<span class="comment">//_/_/ OF SUCH DAMAGE.</span></div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;<span class="comment">//_/_/ </span></div>
<div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;<span class="comment">//_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/</span></div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160; </div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor">#include &quot;utils.h&quot;</span></div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160; </div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;<span class="keyword">using namespace </span>std::chrono;</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160; </div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;<span class="preprocessor">#include &lt;intrin.h&gt;</span></div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor">#pragma intrinsic (_InterlockedDecrement)</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="preprocessor">#pragma intrinsic (_InterlockedIncrement)</span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="preprocessor">#pragma intrinsic (_InterlockedExchange)</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="preprocessor">#pragma intrinsic (_InterlockedExchange64)</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="preprocessor">#pragma intrinsic (_InterlockedCompareExchange)</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="preprocessor">#pragma intrinsic (_InterlockedCompareExchange64)</span></div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160; </div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;<span class="preprocessor">#include &lt;algorithm&gt;</span></div>
<div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;<span class="preprocessor">#include &lt;cctype&gt;</span></div>
<div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;<span class="preprocessor">#include &lt;ctime&gt;</span></div>
<div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160; </div>
<div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160; </div>
<div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;<span class="preprocessor">#define R250_IA (sizeof(uint32)*103)</span></div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;<span class="preprocessor">#define R250_IB (sizeof(uint32)*R250_LEN-R250_IA)</span></div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;<span class="preprocessor">#define R521_IA (sizeof(uint32)*168)</span></div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;<span class="preprocessor">#define R521_IB (sizeof(uint32)*R521_LEN-R521_IA)</span></div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160; </div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;<span class="keyword">namespace </span>core {</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160; </div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;<span class="preprocessor">#if defined LINUX</span></div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;<span class="keywordtype">bool</span> CalcTimeout(<span class="keyword">struct</span> timespec &amp;timeout, uint32 ms) {</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160; </div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <span class="keyword">struct </span>timeval now;</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keywordflow">if</span> (gettimeofday(&amp;now, NULL) != 0)</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160; </div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  timeout.tv_sec = now.tv_sec + ms / 1000;</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keywordtype">long</span> us = now.tv_usec + ms % 1000;</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="keywordflow">if</span> (us &gt;= 1000000) {</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;    timeout.tv_sec++;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    us -= 1000000;</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  }</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  timeout.tv_nsec = us * 1000; <span class="comment">// usec -&gt; nsec</span></div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;}</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160; </div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;uint64 GetTime() {</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  <span class="keyword">struct </span>timeval tv;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  <span class="keywordflow">if</span> (gettimeofday(&amp;tv, NULL))</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="keywordflow">return</span> (tv.tv_usec + tv.tv_sec * 1000000LL);</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;}</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160; </div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;<span class="keywordtype">void</span> Error::PrintBinary(<span class="keywordtype">void</span>* p, uint32 size, <span class="keywordtype">bool</span> asInt, <span class="keyword">const</span> <span class="keywordtype">char</span>* title) {</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="keywordflow">if</span> (title != NULL)</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;    printf(<span class="stringliteral">&quot;--- %s %u ---\n&quot;</span>, title, size);</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="keywordflow">for</span> (uint32 n = 0; n &lt; size; n++) {</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    c = *(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)p) + n);</div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;    <span class="keywordflow">if</span> (asInt)</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;      printf(<span class="stringliteral">&quot;[%u] &quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)c);</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;      printf(<span class="stringliteral">&quot;[%c] &quot;</span>, c);</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="keywordflow">if</span> ((n &gt; 0) &amp;&amp; ((n + 1) % 10 == 0))</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  }</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  printf(<span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;}</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160; </div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;SharedLibrary::SharedLibrary() : library_(NULL) {</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;}</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160; </div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;SharedLibrary::~SharedLibrary() {</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;  <span class="keywordflow">if</span> (library_)</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;    FreeLibrary(library_);</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="keywordflow">if</span> (library_)</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;    dlclose(library_);</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;}</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160; </div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;SharedLibrary *SharedLibrary::load(<span class="keyword">const</span> <span class="keywordtype">char</span> *fileName) {</div>
<div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;  library_ = LoadLibrary(TEXT(fileName));</div>
<div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;  <span class="keywordflow">if</span> (!library_) {</div>
<div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160; </div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    DWORD error = GetLastError();</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    std::cerr &lt;&lt; <span class="stringliteral">&quot;&gt; Error: unable to load shared library &quot;</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">&quot; :&quot;</span> &lt;&lt; error &lt;&lt; std::endl;</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  }</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;<span class="comment">   * libraries on Linux are called &#39;lib&lt;name&gt;.so&#39;</span></div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;<span class="comment">   * if the passed in fileName does not have those</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;<span class="comment">   * components add them in.</span></div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;<span class="comment">   */</span></div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;  <span class="keywordtype">char</span> *libraryName = (<span class="keywordtype">char</span> *)calloc(1, strlen(fileName) + 6 + 1);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;  <span class="keywordflow">if</span> (strstr(fileName, <span class="stringliteral">&quot;lib&quot;</span>) == NULL) {</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;    strcat(libraryName, <span class="stringliteral">&quot;lib&quot;</span>);</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;  }</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  strcat(libraryName, fileName);</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  <span class="keywordflow">if</span> (strstr(fileName + (strlen(fileName) - 3), <span class="stringliteral">&quot;.so&quot;</span>) == NULL) {</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;    strcat(libraryName, <span class="stringliteral">&quot;.so&quot;</span>);</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  }</div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  library_ = dlopen(libraryName, RTLD_NOW | RTLD_GLOBAL);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="keywordflow">if</span> (!library_) {</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;    std::cout &lt;&lt; <span class="stringliteral">&quot;&gt; Error: unable to load shared library &quot;</span> &lt;&lt; fileName &lt;&lt; <span class="stringliteral">&quot; :&quot;</span> &lt;&lt; dlerror() &lt;&lt; std::endl;</div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;    free(libraryName);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;    <span class="keywordflow">return</span> NULL;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;  }</div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  free(libraryName);</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">this</span>;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;}</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160; </div>
<div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160; </div>
<div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;<span class="keywordtype">void</span>* SharedLibrary::getFunction(<span class="keyword">const</span> <span class="keywordtype">char</span>* functionName) {</div>
<div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;  <span class="keywordtype">void</span>* <span class="keyword">function</span> = NULL;</div>
<div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;  <span class="keywordflow">if</span> (library_) {</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160; </div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;    <span class="keyword">function</span> = GetProcAddress(library_, functionName);</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;    <span class="keywordflow">if</span> (!<span class="keyword">function</span>) {</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160; </div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;      DWORD error = GetLastError();</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;      std::cerr &lt;&lt; <span class="stringliteral">&quot;GetProcAddress &gt; Error: &quot;</span> &lt;&lt; error &lt;&lt; std::endl;</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;    }</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  }</div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  <span class="keywordflow">if</span> (library_) {</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;    <span class="keyword">function</span> = dlsym(library_, functionName);</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;    <span class="keywordflow">if</span> (!<span class="keyword">function</span>) {</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;      std::cout &lt;&lt; <span class="stringliteral">&quot;&gt; Error: unable to find symbol &quot;</span> &lt;&lt; functionName &lt;&lt; <span class="stringliteral">&quot; :&quot;</span> &lt;&lt; dlerror() &lt;&lt; std::endl;</div>
<div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;    }</div>
<div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;  }</div>
<div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">function</span>;</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;}</div>
<div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160; </div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160; </div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="keywordtype">void</span> Thread::TerminateAndWait(Thread **threads, uint32 threadCount) {</div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  <span class="keywordflow">if</span> (!threads)</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  <span class="keywordflow">for</span> (uint32 i = 0; i &lt; threadCount; i++) {</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;    threads[i]-&gt;terminate();</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    Thread::Wait(threads[i]);</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  }</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;}</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160; </div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;<span class="keywordtype">void</span> Thread::TerminateAndWait(Thread *thread) {</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  <span class="keywordflow">if</span> (!thread)</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  thread-&gt;terminate();</div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  Thread::Wait(thread);</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;}</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160; </div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;<span class="keywordtype">void</span> Thread::Wait(Thread **threads, uint32 threadCount) {</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; </div>
<div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <span class="keywordflow">if</span> (!threads)</div>
<div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="keywordflow">for</span> (uint32 i = 0; i &lt; threadCount; i++)</div>
<div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;    WaitForSingleObject(threads[i]-&gt;thread_, INFINITE);</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;  <span class="keywordflow">for</span> (uint32 i = 0; i &lt; threadCount; i++)</div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    pthread_join(threads[i]-&gt;thread_, NULL);</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;}</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160; </div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;<span class="keywordtype">void</span> Thread::Wait(Thread *thread) {</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160; </div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;  <span class="keywordflow">if</span> (!thread)</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;  WaitForSingleObject(thread-&gt;thread_, INFINITE);</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;  pthread_join(thread-&gt;thread_, NULL);</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;}</div>
<div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160; </div>
<div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;<span class="keywordtype">void</span> Thread::Sleep(milliseconds ms) {</div>
<div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;  ::Sleep((uint32)ms.count());</div>
<div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  <span class="comment">// we are actually being passed millisecond, so multiply up</span></div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;  usleep(ms.count() * 1000);</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;}</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160; </div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;<span class="keywordtype">void</span> Thread::Sleep() {</div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;  ::Sleep(INFINITE);</div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;  <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    sleep(1000);</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;}</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160; </div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;Thread::Thread() : is_meaningful_(false) {</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;  thread_ = 0;</div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;}</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160; </div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;Thread::~Thread() {</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  <span class="comment">// ExitThread(0);</span></div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;  <span class="keywordflow">if</span> (is_meaningful_)</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;    CloseHandle(thread_);</div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  <span class="comment">// delete(thread_);</span></div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;}</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160; </div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="keywordtype">void</span> Thread::start(thread_function f) {</div>
<div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  thread_ = CreateThread(NULL, 65536, f, <span class="keyword">this</span>, 0, NULL); <span class="comment">// 64KB: minimum initial stack size</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;  pthread_create(&amp;thread_, NULL, f, <span class="keyword">this</span>);</div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  is_meaningful_ = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;}</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160; </div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;<span class="keywordtype">void</span> Thread::suspend() {</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  SuspendThread(thread_);</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  pthread_kill(thread_, SIGSTOP);</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;}</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160; </div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="keywordtype">void</span> Thread::resume() {</div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;  ResumeThread(thread_);</div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  pthread_kill(thread_, SIGCONT);</div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;}</div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160; </div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;<span class="keywordtype">void</span> Thread::terminate() {</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  TerminateThread(thread_, 0);</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  pthread_cancel(thread_);</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;}</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160; </div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160; </div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;<span class="keywordtype">void</span> TimeProbe::set() {</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160; </div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;  cpu_counts_ = getCounts();</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;}</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160; </div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;int64 TimeProbe::getCounts() {</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;  LARGE_INTEGER counter;</div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;  QueryPerformanceCounter(&amp;counter);</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;  <span class="keywordflow">return</span> counter.QuadPart;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;  <span class="keyword">static</span> <span class="keyword">struct </span>timeval tv;</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;  <span class="keyword">static</span> <span class="keyword">struct </span>timezone tz;</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  gettimeofday(&amp;tv, &amp;tz);</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;  <span class="keywordflow">return</span> (((int64)tv.tv_sec) * 1000000) + (int64)tv.tv_usec;</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;#endif</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;}</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160; </div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;<span class="keywordtype">void</span> TimeProbe::check() {</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160; </div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  cpu_counts_ = getCounts() - cpu_counts_;</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;}</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160; </div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160; </div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="keyword">typedef</span> LONG NTSTATUS;</div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;<span class="keyword">typedef</span> NTSTATUS(__stdcall *NSTR)(ULONG, BOOLEAN, PULONG);</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="preprocessor">#define STATUS_SUCCESS ((NTSTATUS)0x00000000L)</span></div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="keywordtype">bool</span> NtSetTimerResolution(IN ULONG RequestedResolution, IN BOOLEAN Set, OUT PULONG ActualResolution);</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;  <span class="comment">// TODO</span></div>
<div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160; </div>
<div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;float64 Time::Period_;</div>
<div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160; </div>
<div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;Timestamp Time::InitTime_;</div>
<div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160; </div>
<div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;<span class="keywordtype">void</span> Time::Init(uint32 r) {</div>
<div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;  NTSTATUS nts;</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  HMODULE NTDll = ::LoadLibrary(<span class="stringliteral">&quot;NTDLL&quot;</span>);</div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;  ULONG actualResolution = 0;</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;  <span class="keywordflow">if</span> (NTDll) {</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160; </div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    NSTR pNSTR = (NSTR)::GetProcAddress(NTDll, <span class="stringliteral">&quot;NtSetTimerResolution&quot;</span>); <span class="comment">// undocumented win xp sys internals</span></div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    <span class="keywordflow">if</span> (pNSTR)</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;      nts = (*pNSTR)(10 * r, <span class="keyword">true</span>, &amp;actualResolution); <span class="comment">// in 100 ns units</span></div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;  }</div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;  LARGE_INTEGER f;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  QueryPerformanceFrequency(&amp;f);</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  Period_ = 1000000.0 / f.QuadPart; <span class="comment">// in us</span></div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;  <span class="keyword">struct </span>_timeb local_time;</div>
<div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;  _ftime(&amp;local_time);</div>
<div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;  <span class="keyword">auto</span> now = Timestamp(microseconds((int64)(local_time.time * 1000 + local_time.millitm) * 1000));</div>
<div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;  <span class="comment">// The QueryPerformanceCounter in Get() may not start at zero, so subtract it initially.</span></div>
<div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;  InitTime_ = Timestamp(seconds(0));</div>
<div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;  InitTime_ = now - Get().time_since_epoch();</div>
<div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;  <span class="comment">// The steady_clock in Get() may not start at zero, so subtract it initially.</span></div>
<div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  InitTime_ = system_clock_us::now() - duration_cast&lt;microseconds&gt;(steady_clock::now().time_since_epoch());</div>
<div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;}</div>
<div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160; </div>
<div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;Timestamp Time::Get() {</div>
<div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  LARGE_INTEGER counter;</div>
<div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;  QueryPerformanceCounter(&amp;counter);</div>
<div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <span class="keywordflow">return</span> InitTime_ + microseconds((uint64)(counter.QuadPart * Period_));</div>
<div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;  <span class="keywordflow">return</span> InitTime_ + duration_cast&lt;microseconds&gt;(steady_clock::now().time_since_epoch());</div>
<div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;}</div>
<div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160; </div>
<div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;std::string Time::ToString_year(Timestamp timestamp) {</div>
<div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  <span class="comment">// For now, assume all times are after the epoch. Take the absolute value to be sure.</span></div>
<div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;  uint64 t = abs(duration_cast&lt;microseconds&gt;(timestamp.time_since_epoch()).count());</div>
<div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160; </div>
<div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  uint64 us = t % 1000;</div>
<div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  uint64 ms = t / 1000;</div>
<div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;  uint64 s = ms / 1000;</div>
<div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  ms = ms % 1000;</div>
<div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160; </div>
<div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;  time_t _gmt_time = s;</div>
<div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  <span class="keyword">struct </span>tm   *_t = gmtime(&amp;_gmt_time);</div>
<div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160; </div>
<div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  std::string _s = asctime(_t); <span class="comment">// _s is: Www Mmm dd hh:mm:ss yyyy but we want: Www Mmm dd yyyy hh:mm:ss:msmsms:ususus</span></div>
<div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  std::string year = _s.substr(_s.length() - 5, 4);</div>
<div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  _s.erase(_s.length() - 6, 5);</div>
<div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;  std::string hh_mm_ss = _s.substr(_s.length() - 9, 8);</div>
<div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;  hh_mm_ss += <span class="stringliteral">&quot;:&quot;</span>;</div>
<div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  hh_mm_ss += std::to_string(ms);</div>
<div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  hh_mm_ss += <span class="stringliteral">&quot;:&quot;</span>;</div>
<div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  hh_mm_ss += std::to_string(us);</div>
<div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160; </div>
<div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  _s.erase(_s.length() - 9, 9);</div>
<div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;  _s += year;</div>
<div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;  _s += <span class="stringliteral">&quot; &quot;</span>;</div>
<div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;  _s += hh_mm_ss;</div>
<div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;  _s += <span class="stringliteral">&quot; GMT&quot;</span>;</div>
<div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160; </div>
<div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;  <span class="keywordflow">return</span> _s;</div>
<div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;}</div>
<div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160; </div>
<div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160; </div>
<div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;uint8 Host::Name(<span class="keywordtype">char</span> *name) {</div>
<div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;  DWORD s = 255;</div>
<div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  GetComputerName(name, &amp;s);</div>
<div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;  <span class="keywordflow">return</span> (uint8)s;</div>
<div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;  <span class="keyword">struct </span>utsname utsname;</div>
<div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;  uname(&amp;utsname);</div>
<div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;  strcpy(name, utsname.nodename);</div>
<div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;  <span class="keywordflow">return</span> strlen(name);</div>
<div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;}</div>
<div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160; </div>
<div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160; </div>
<div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;<span class="keyword">const</span> uint32 Semaphore::Infinite = INFINITE;</div>
<div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;<span class="comment">   * Normally this should be SEM_VALUE_MAX but apparently the &lt;semaphore.h&gt; header</span></div>
<div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;<span class="comment">   * does not define it. The documents I have read indicate that on Linux it is</span></div>
<div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">   * always equal to INT_MAX - so use that instead.</span></div>
<div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;<span class="comment">   */</span></div>
<div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;<span class="keyword">const</span> uint32 Semaphore::Infinite = INT_MAX;</div>
<div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160; </div>
<div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;Semaphore::Semaphore(uint32 initialCount, uint32 maxCount) {</div>
<div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  s_ = CreateSemaphore(NULL, initialCount, maxCount, NULL);</div>
<div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;  sem_init(&amp;s_, 0, initialCount);</div>
<div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;}</div>
<div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160; </div>
<div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;Semaphore::~Semaphore() {</div>
<div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;  CloseHandle(s_);</div>
<div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;  sem_destroy(&amp;s_);</div>
<div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;}</div>
<div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160; </div>
<div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;<span class="keywordtype">bool</span> Semaphore::acquire(uint32 timeout) {</div>
<div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;  uint32 r = WaitForSingleObject(s_, timeout);</div>
<div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;  <span class="keywordflow">return</span> r == WAIT_TIMEOUT;</div>
<div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;  <span class="keyword">struct </span>timespec t;</div>
<div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  <span class="keywordtype">int</span> r;</div>
<div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160; </div>
<div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;  CalcTimeout(t, timeout);</div>
<div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;  r = sem_timedwait(&amp;s_, &amp;t);</div>
<div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;  <span class="keywordflow">return</span> r == 0;</div>
<div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;}</div>
<div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160; </div>
<div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;<span class="keywordtype">void</span> Semaphore::release(uint32 count) {</div>
<div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  ReleaseSemaphore(s_, count, NULL);</div>
<div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;  <span class="keywordflow">for</span> (uint32 c = 0; c &lt; count; c++)</div>
<div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    sem_post(&amp;s_);</div>
<div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;}</div>
<div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160; </div>
<div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;<span class="keywordtype">void</span> Semaphore::reset() {</div>
<div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;  <span class="keywordtype">bool</span> r;</div>
<div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;  <span class="keywordflow">do</span></div>
<div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;    r = acquire(0);</div>
<div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;  <span class="keywordflow">while</span> (!r);</div>
<div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;  <span class="keywordtype">bool</span> r;</div>
<div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;  <span class="keywordflow">do</span></div>
<div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;    r = acquire(0);</div>
<div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;  <span class="keywordflow">while</span> (!r);</div>
<div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;}</div>
<div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160; </div>
<div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160; </div>
<div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="keyword">const</span> uint32 Mutex::Infinite = INFINITE;</div>
<div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;<span class="comment">   * Normally this should be SEM_VALUE_MAX but apparently the &lt;semaphore.h&gt; header</span></div>
<div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;<span class="comment">   * does not define it. The documents I have read indicate that on Linux it is</span></div>
<div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;<span class="comment">   * always equal to INT_MAX - so use that instead.</span></div>
<div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;<span class="comment">   */</span></div>
<div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;<span class="keyword">const</span> uint32 Mutex::Infinite = INT_MAX;</div>
<div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160; </div>
<div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;Mutex::Mutex() {</div>
<div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;  m_ = CreateMutex(NULL, <span class="keyword">false</span>, NULL);</div>
<div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  pthread_mutex_init(&amp;m_, NULL);</div>
<div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;}</div>
<div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160; </div>
<div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;Mutex::~Mutex() {</div>
<div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;  CloseHandle(m_);</div>
<div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;  pthread_mutex_destroy(&amp;m_);</div>
<div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;}</div>
<div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160; </div>
<div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="keywordtype">bool</span> Mutex::acquire(uint32 timeout) {</div>
<div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;  uint32 r = WaitForSingleObject(m_, timeout);</div>
<div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;  <span class="keywordflow">return</span> r == WAIT_TIMEOUT;</div>
<div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;  <span class="keyword">auto</span> start = Time::Get();</div>
<div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;  <span class="keyword">auto</span> uTimeout = microseconds(timeout * 1000);</div>
<div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160; </div>
<div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;  <span class="keywordflow">while</span> (pthread_mutex_trylock(&amp;m_) != 0) {</div>
<div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;    Thread::Sleep(milliseconds(10));</div>
<div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;    <span class="keywordflow">if</span> (Time::Get() - start &gt;= uTimeout)</div>
<div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;  }</div>
<div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160; </div>
<div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;}</div>
<div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160; </div>
<div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;<span class="keywordtype">void</span> Mutex::release() {</div>
<div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;  ReleaseMutex(m_);</div>
<div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;  pthread_mutex_unlock(&amp;m_);</div>
<div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;}</div>
<div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160; </div>
<div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160; </div>
<div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;CriticalSection::CriticalSection() {</div>
<div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;  InitializeCriticalSection(&amp;cs_);</div>
<div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;  pthread_mutex_init(&amp;cs_, NULL);</div>
<div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;}</div>
<div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160; </div>
<div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;CriticalSection::~CriticalSection() {</div>
<div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;  DeleteCriticalSection(&amp;cs_);</div>
<div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;  pthread_mutex_destroy(&amp;cs_);</div>
<div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;}</div>
<div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160; </div>
<div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;<span class="keywordtype">void</span> CriticalSection::enter() {</div>
<div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;  EnterCriticalSection(&amp;cs_);</div>
<div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  pthread_mutex_lock(&amp;cs_);</div>
<div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;}</div>
<div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160; </div>
<div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;<span class="keywordtype">void</span> CriticalSection::leave() {</div>
<div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;  LeaveCriticalSection(&amp;cs_);</div>
<div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;  pthread_mutex_unlock(&amp;cs_);</div>
<div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;}</div>
<div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160; </div>
<div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160; </div>
<div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;<span class="keyword">const</span> uint32 Timer::Infinite = INFINITE;</div>
<div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;<span class="keyword">const</span> uint32 Timer::Infinite = INT_MAX;</div>
<div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160; </div>
<div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;<span class="keyword">static</span> <span class="keywordtype">void</span> timer_signal_handler(<span class="keywordtype">int</span> sig, siginfo_t *siginfo, <span class="keywordtype">void</span> *context) {</div>
<div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;  SemaTex* sematex = (SemaTex*)siginfo-&gt;si_value.sival_ptr;</div>
<div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;  if (sematex == NULL)</div>
<div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;  pthread_mutex_lock(&amp;sematex-&gt;mutex);</div>
<div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;  pthread_cond_broadcast(&amp;sematex-&gt;semaphore);</div>
<div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;  pthread_mutex_unlock(&amp;sematex-&gt;mutex);</div>
<div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;}</div>
<div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160; </div>
<div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;Timer::Timer() {</div>
<div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;  t_ = CreateWaitableTimer(NULL, <span class="keyword">false</span>, NULL);</div>
<div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;  <span class="keywordflow">if</span> (t_ == NULL) {</div>
<div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;    printf(<span class="stringliteral">&quot;Error creating timer\n&quot;</span>);</div>
<div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  }</div>
<div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  pthread_cond_init(&amp;sematex.semaphore, NULL);</div>
<div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;  pthread_mutex_init(&amp;sematex.mutex, NULL);</div>
<div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160; </div>
<div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  <span class="keyword">struct </span>sigaction sa;</div>
<div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;  <span class="keyword">struct </span>sigevent timer_event;</div>
<div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160; </div>
<div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;  sigemptyset(&amp;sa.sa_mask);</div>
<div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;  sa.sa_flags = SA_SIGINFO;   <span class="comment">/* Real-Time signal */</span></div>
<div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;  sa.sa_sigaction = timer_signal_handler;</div>
<div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;  sigaction(SIGRTMIN, &amp;sa, NULL);</div>
<div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160; </div>
<div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;  timer_event.sigev_notify = SIGEV_SIGNAL;</div>
<div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;  timer_event.sigev_signo = SIGRTMIN;</div>
<div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;  timer_event.sigev_value.sival_ptr = (<span class="keywordtype">void</span> *)&amp;sematex;</div>
<div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;  <span class="keywordtype">int</span> ret = timer_create(CLOCK_REALTIME, &amp;timer_event, &amp;timer);</div>
<div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;  <span class="keywordflow">if</span> (ret != 0) {</div>
<div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;    printf(<span class="stringliteral">&quot;Error creating timer: %d\n&quot;</span>, ret);</div>
<div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;  }</div>
<div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;}</div>
<div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160; </div>
<div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;Timer::~Timer() {</div>
<div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;  CloseHandle(t_);</div>
<div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  pthread_cond_destroy(&amp;sematex.semaphore);</div>
<div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;  pthread_mutex_destroy(&amp;sematex.mutex);</div>
<div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;  timer_delete(timer);</div>
<div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;}</div>
<div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160; </div>
<div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;<span class="keywordtype">void</span> Timer::start(microseconds deadline, milliseconds period) {</div>
<div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;  LARGE_INTEGER _deadline; <span class="comment">// in 100 ns intervals</span></div>
<div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;  _deadline.QuadPart = -10LL * deadline.count(); <span class="comment">// negative means relative</span></div>
<div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;  <span class="keywordtype">bool</span> r = SetWaitableTimer(t_, &amp;_deadline, (<span class="keywordtype">long</span>)period.count(), NULL, NULL, 0);</div>
<div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  <span class="keywordflow">if</span> (!r) {</div>
<div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;    printf(<span class="stringliteral">&quot;Error arming timer\n&quot;</span>);</div>
<div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;  }</div>
<div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;  <span class="keyword">struct </span>itimerspec newtv;</div>
<div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;  sigset_t allsigs;</div>
<div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160; </div>
<div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;  uint64 t = deadline.count();</div>
<div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;  uint64 p = period.count() * 1000;</div>
<div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;  newtv.it_interval.tv_sec = p / 1000000;</div>
<div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;  newtv.it_interval.tv_nsec = (p % 1000000) * 1000;</div>
<div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;  newtv.it_value.tv_sec = t / 1000000;</div>
<div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;  newtv.it_value.tv_nsec = (t % 1000000) * 1000;</div>
<div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160; </div>
<div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;  pthread_mutex_lock(&amp;sematex.mutex);</div>
<div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160; </div>
<div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;  <span class="keywordtype">int</span> ret = timer_settime(timer, 0, &amp;newtv, NULL);</div>
<div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;  <span class="keywordflow">if</span> (ret != 0) {</div>
<div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;    printf(<span class="stringliteral">&quot;Error arming timer: %d\n&quot;</span>, ret);</div>
<div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;  }</div>
<div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;  sigemptyset(&amp;allsigs);</div>
<div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160; </div>
<div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;  pthread_mutex_unlock(&amp;sematex.mutex);</div>
<div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;}</div>
<div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160; </div>
<div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;<span class="keywordtype">bool</span> Timer::wait(uint32 timeout) {</div>
<div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;  uint32 r = WaitForSingleObject(t_, timeout);</div>
<div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;  <span class="keywordflow">return</span> r == WAIT_TIMEOUT;</div>
<div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  <span class="keywordtype">bool</span> res;</div>
<div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;  <span class="keyword">struct </span>timespec ttimeout;</div>
<div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160; </div>
<div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;  pthread_mutex_lock(&amp;sematex.mutex);</div>
<div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;  <span class="keywordflow">if</span> (timeout == INT_MAX) {</div>
<div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;    res = (pthread_cond_wait(&amp;sematex.semaphore, &amp;sematex.mutex) == 0);</div>
<div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;  }</div>
<div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;    CalcTimeout(ttimeout, timeout);</div>
<div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;    res = (pthread_cond_timedwait(&amp;sematex.semaphore, &amp;sematex.mutex, &amp;ttimeout) == 0);</div>
<div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;  }</div>
<div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;  pthread_mutex_unlock(&amp;sematex.mutex);</div>
<div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;  <span class="keywordflow">return</span> res;</div>
<div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;}</div>
<div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160; </div>
<div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160; </div>
<div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;Event::Event() {</div>
<div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;  e_ = CreateEvent(NULL, <span class="keyword">true</span>, <span class="keyword">false</span>, NULL);</div>
<div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;  <span class="comment">// TODO.</span></div>
<div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;}</div>
<div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160; </div>
<div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;Event::~Event() {</div>
<div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;  CloseHandle(e_);</div>
<div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  <span class="comment">// TODO.</span></div>
<div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;}</div>
<div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160; </div>
<div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;<span class="keywordtype">void</span> Event::wait() {</div>
<div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;  WaitForSingleObject(e_, INFINITE);</div>
<div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  <span class="comment">// TODO.</span></div>
<div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;}</div>
<div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160; </div>
<div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;<span class="keywordtype">void</span> Event::fire() {</div>
<div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;  SetEvent(e_);</div>
<div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <span class="comment">// TODO.</span></div>
<div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;}</div>
<div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160; </div>
<div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;<span class="keywordtype">void</span> Event::reset() {</div>
<div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;  ResetEvent(e_);</div>
<div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  <span class="comment">// TODO.</span></div>
<div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;}</div>
<div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160; </div>
<div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160; </div>
<div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;<span class="keywordtype">void</span> SignalHandler::Add(signal_handler h) {</div>
<div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;  <span class="keywordflow">if</span> (SetConsoleCtrlHandler(h, <span class="keyword">true</span>) == 0) {</div>
<div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160; </div>
<div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;    <span class="keywordtype">int</span> e = GetLastError();</div>
<div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    std::cerr &lt;&lt; <span class="stringliteral">&quot;Error: &quot;</span> &lt;&lt; e &lt;&lt; <span class="stringliteral">&quot; failed to add signal handler&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;    <span class="keywordflow">return</span>;</div>
<div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;  }</div>
<div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;  signal(SIGABRT, SIG_IGN);</div>
<div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;  signal(SIGPIPE, SIG_IGN);</div>
<div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;  signal(SIGBUS, SIG_IGN);</div>
<div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;  <span class="comment">//   signal(SIGHUP, h);</span></div>
<div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;  signal(SIGTERM, h);</div>
<div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;  signal(SIGINT, h);</div>
<div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;  signal(SIGABRT, h);</div>
<div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;  <span class="comment">//   signal(SIGFPE, h);</span></div>
<div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;  <span class="comment">//   signal(SIGILL, h);</span></div>
<div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;  <span class="comment">//   signal(SIGSEGV, h);</span></div>
<div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;}</div>
<div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160; </div>
<div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;<span class="keywordtype">void</span> SignalHandler::Remove(signal_handler h) {</div>
<div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;  SetConsoleCtrlHandler(h, <span class="keyword">false</span>);</div>
<div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;  signal(SIGABRT, SIG_IGN);</div>
<div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;  signal(SIGPIPE, SIG_IGN);</div>
<div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;  signal(SIGBUS, SIG_IGN);</div>
<div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;  <span class="comment">//   signal(SIGHUP, SIG_DFL);</span></div>
<div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;  signal(SIGTERM, SIG_DFL);</div>
<div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;  signal(SIGINT, SIG_DFL);</div>
<div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;  signal(SIGABRT, SIG_DFL);</div>
<div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;  <span class="comment">//   signal(SIGFPE, SIG_DFL);</span></div>
<div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;  <span class="comment">//   signal(SIGILL, SIG_DFL);</span></div>
<div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;  <span class="comment">//   signal(SIGSEGV, SIG_DFL);</span></div>
<div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;}</div>
<div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160; </div>
<div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160; </div>
<div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;uint8 BSR(word data) {</div>
<div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;<span class="preprocessor">#if defined WINDOWS</span></div>
<div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;<span class="preprocessor">#if defined ARCH_32</span></div>
<div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;  DWORD index;</div>
<div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;  _BitScanReverse(&amp;index, data);</div>
<div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;  <span class="keywordflow">return</span> (uint8)index;</div>
<div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;<span class="preprocessor">#elif defined ARCH_64</span></div>
<div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;  DWORD index;</div>
<div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;  _BitScanReverse64(&amp;index, data);</div>
<div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;  <span class="keywordflow">return</span> (uint8)index;</div>
<div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;<span class="preprocessor">#elif defined LINUX</span></div>
<div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;<span class="preprocessor">#if defined ARCH_32</span></div>
<div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;  <span class="keywordflow">return</span> (uint8)(31 - __builtin_clz((uint32_t)data));</div>
<div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;<span class="preprocessor">#elif defined ARCH_64</span></div>
<div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;  <span class="keywordflow">return</span> (uint8)(63 - __builtin_clzll((uint64_t)data));</div>
<div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;}</div>
<div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160; </div>
<div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160; </div>
<div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;FastSemaphore::FastSemaphore(uint32 initialCount, uint32 maxCount) : Semaphore(initialCount &gt; 0 ? 1 : 0, 1), count_(initialCount), maxCount_(maxCount) {</div>
<div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;}</div>
<div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160; </div>
<div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;FastSemaphore::~FastSemaphore() {</div>
<div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;}</div>
<div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160; </div>
<div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;<span class="keywordtype">void</span> FastSemaphore::acquire() {</div>
<div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160; </div>
<div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;  int32 c;</div>
<div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;  <span class="keywordflow">while</span> ((c = --count_) &gt;= maxCount_); <span class="comment">// release calls can bring count over maxCount_: acquire has to exhaust these extras</span></div>
<div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;  <span class="keywordflow">if</span> (c &lt; 0)</div>
<div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;    Semaphore::acquire();</div>
<div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;}</div>
<div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160; </div>
<div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="keywordtype">void</span> FastSemaphore::release() {</div>
<div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160; </div>
<div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;  int32 c = ++count_;</div>
<div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;  <span class="keywordflow">if</span> (c &lt;= 0)</div>
<div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;    Semaphore::release();</div>
<div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;}</div>
<div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160; </div>
<div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;<span class="comment">  FastMutex::FastMutex(uint32 initialCount):Semaphore(initialCount,1),count_(initialCount){</span></div>
<div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;<span class="comment">  FastMutex::~FastMutex(){</span></div>
<div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;<span class="comment">  void FastMutex::acquire(){</span></div>
<div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="comment">    int32 former=Atomic::Swap32(&amp;count_,0);</span></div>
<div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="comment">    if(former==0)</span></div>
<div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;<span class="comment">      Semaphore::acquire();</span></div>
<div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;<span class="comment">  void FastMutex::release(){</span></div>
<div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;<span class="comment">    int32 former=Atomic::Swap32(&amp;count_,1);</span></div>
<div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;<span class="comment">    if(former==0)</span></div>
<div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;<span class="comment">      Semaphore::release();</span></div>
<div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;<span class="comment">  }</span></div>
<div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160; </div>
<div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;<span class="keywordtype">bool</span> Error::PrintLastOSErrorMessage(<span class="keyword">const</span> <span class="keywordtype">char</span>* title) {</div>
<div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;  int32 err = Error::GetLastOSErrorNumber();</div>
<div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;  <span class="keywordtype">char</span> buf[1024];</div>
<div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;  <span class="keywordflow">if</span> (!Error::GetOSErrorMessage(buf, 1024, err))</div>
<div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;    printf(<span class="stringliteral">&quot;%s: [%d] (could not get error message)\n&quot;</span>, title, err);</div>
<div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;    printf(<span class="stringliteral">&quot;%s: [%d] %s\n&quot;</span>, title, err, buf);</div>
<div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;}</div>
<div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160; </div>
<div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;int32 Error::GetLastOSErrorNumber() {</div>
<div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;<span class="preprocessor">#ifdef WINDOWS</span></div>
<div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;  int32 err = WSAGetLastError();</div>
<div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;  WSASetLastError(0);</div>
<div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;  <span class="keywordflow">return</span> err;</div>
<div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;  <span class="keywordflow">return</span> (int32)errno;</div>
<div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;}</div>
<div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160; </div>
<div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;<span class="keywordtype">bool</span> Error::GetOSErrorMessage(<span class="keywordtype">char</span>* buffer, uint32 buflen, int32 err) {</div>
<div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;  <span class="keywordflow">if</span> (buffer == NULL)</div>
<div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;  <span class="keywordflow">if</span> (buflen &lt; 512) {</div>
<div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;String buffer not large enough&quot;</span>);</div>
<div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;  }</div>
<div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;  <span class="keywordflow">if</span> (err &lt; 0)</div>
<div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;    err = Error::GetLastOSErrorNumber();</div>
<div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160; </div>
<div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;<span class="preprocessor">#ifdef WINDOWS</span></div>
<div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;  <span class="keywordflow">if</span> (err == WSANOTINITIALISED) {</div>
<div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;Cannot initialize WinSock!&quot;</span>);</div>
<div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;  }</div>
<div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAENETDOWN) {</div>
<div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The network subsystem or the associated service provider has failed&quot;</span>);</div>
<div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;  }</div>
<div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEAFNOSUPPORT) {</div>
<div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The specified address family is not supported&quot;</span>);</div>
<div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;  }</div>
<div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEINPROGRESS) {</div>
<div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;A blocking Windows Sockets 1.1 call is in progress, or the service provider is still processing a callback function&quot;</span>);</div>
<div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;  }</div>
<div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEMFILE) {</div>
<div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;No more socket descriptors are available&quot;</span>);</div>
<div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;  }</div>
<div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAENOBUFS) {</div>
<div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;No buffer space is available. The socket cannot be created&quot;</span>);</div>
<div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;  }</div>
<div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEPROTONOSUPPORT) {</div>
<div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The specified protocol is not supported&quot;</span>);</div>
<div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;  }</div>
<div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEPROTOTYPE) {</div>
<div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The specified protocol is the wrong type for this socket&quot;</span>);</div>
<div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;  }</div>
<div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAESOCKTNOSUPPORT) {</div>
<div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The specified socket type is not supported in this address family&quot;</span>);</div>
<div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;  }</div>
<div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEADDRINUSE) {</div>
<div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The socket&#39;s local address is already in use and the socket was not marked to allow address reuse with SO_REUSEADDR. This error usually occurs during execution of the bind function, but could be delayed until this function if the bind was to a partially wildcard address (involving ADDR_ANY) and if a specific address needs to be committed at the time of this function&quot;</span>);</div>
<div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;  }</div>
<div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEINVAL) {</div>
<div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The socket has not been bound with bind&quot;</span>);</div>
<div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;  }</div>
<div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEISCONN) {</div>
<div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The socket is already connected&quot;</span>);</div>
<div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;  }</div>
<div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAENOTSOCK) {</div>
<div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The descriptor is not a socket&quot;</span>);</div>
<div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;  }</div>
<div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEOPNOTSUPP) {</div>
<div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The referenced socket is not of a type that supports the listen operation&quot;</span>);</div>
<div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;  }</div>
<div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEADDRNOTAVAIL) {</div>
<div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The specified address is not a valid address for this machine&quot;</span>);</div>
<div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;  }</div>
<div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEFAULT) {</div>
<div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The name or namelen parameter is not a valid part of the user address space, the namelen parameter is too small, the name parameter contains an incorrect address format for the associated address family, or the first two bytes of the memory block specified by name does not match the address family associated with the socket descriptor s&quot;</span>);</div>
<div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;  }</div>
<div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEMFILE) {</div>
<div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The queue is nonempty upon entry to accept and there are no descriptors available&quot;</span>);</div>
<div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  }</div>
<div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == SOCKETWOULDBLOCK) {</div>
<div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The socket is marked as nonblocking and no connections are present to be accepted&quot;</span>);</div>
<div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;  }</div>
<div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAETIMEDOUT) {</div>
<div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;Attempt to connect timed out without establishing a connection&quot;</span>);</div>
<div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;  }</div>
<div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAENETUNREACH) {</div>
<div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The network cannot be reached from this host at this time&quot;</span>);</div>
<div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;  }</div>
<div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEISCONN) {</div>
<div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The socket is already connected (connection-oriented sockets only)&quot;</span>);</div>
<div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;  }</div>
<div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAECONNREFUSED) {</div>
<div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The attempt to connect was forcefully rejected&quot;</span>);</div>
<div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;  }</div>
<div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEAFNOSUPPORT) {</div>
<div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;Addresses in the specified family cannot be used with this socket&quot;</span>);</div>
<div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;  }</div>
<div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEADDRNOTAVAIL) {</div>
<div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;The remote address is not a valid address (such as ADDR_ANY)&quot;</span>);</div>
<div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;  }</div>
<div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAEALREADY) {</div>
<div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;A nonblocking connect call is in progress on the specified socket&quot;</span>);</div>
<div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;  }</div>
<div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAECONNRESET) {</div>
<div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;Connection was reset&quot;</span>);</div>
<div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;  }</div>
<div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == WSAECONNABORTED) {</div>
<div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;Software caused connection abort&quot;</span>);</div>
<div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;  }</div>
<div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;  <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;    strcpy(buffer, <span class="stringliteral">&quot;Socket error with no description&quot;</span>);</div>
<div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;  }</div>
<div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160; </div>
<div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;  strcpy(buffer, strerror(err));</div>
<div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160; </div>
<div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;}</div>
<div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160; </div>
<div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160; </div>
<div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;<span class="keywordtype">bool</span> WaitForSocketReadability(socket s, int32 timeout) {</div>
<div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160; </div>
<div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;  <span class="keywordtype">int</span> maxfd = 0;</div>
<div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160; </div>
<div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;  <span class="keyword">struct </span>timeval tv;</div>
<div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;  tv.tv_sec = 0;</div>
<div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;  tv.tv_usec = 0;</div>
<div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160; </div>
<div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;  fd_set rdds;</div>
<div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  <span class="comment">// create a list of sockets to check for activity</span></div>
<div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;  FD_ZERO(&amp;rdds);</div>
<div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;  <span class="comment">// specify mySocket</span></div>
<div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;  FD_SET(s, &amp;rdds);</div>
<div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160; </div>
<div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;<span class="preprocessor">#ifdef WINDOWS</span></div>
<div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;  maxfd = s + 1;</div>
<div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160; </div>
<div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;  <span class="keywordflow">if</span> (timeout &gt; 0) {</div>
<div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;    ldiv_t d = ldiv(timeout * 1000, 1000000);</div>
<div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;    tv.tv_sec = d.quot;</div>
<div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;    tv.tv_usec = d.rem;</div>
<div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;  }</div>
<div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160; </div>
<div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;  <span class="comment">// Check for readability</span></div>
<div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;  <span class="keywordtype">int</span> ret = select(maxfd, &amp;rdds, NULL, NULL, &amp;tv);</div>
<div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;  <span class="keywordflow">return</span>(ret &gt; 0);</div>
<div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;}</div>
<div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160; </div>
<div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;<span class="keywordtype">bool</span> WaitForSocketWriteability(socket s, int32 timeout) {</div>
<div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160; </div>
<div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;  <span class="keywordtype">int</span> maxfd = 0;</div>
<div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160; </div>
<div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;  <span class="keyword">struct </span>timeval tv;</div>
<div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;  tv.tv_sec = 0;</div>
<div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;  tv.tv_usec = 0;</div>
<div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160; </div>
<div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;  fd_set wds;</div>
<div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;  <span class="comment">// create a list of sockets to check for activity</span></div>
<div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;  FD_ZERO(&amp;wds);</div>
<div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;  <span class="comment">// specify mySocket</span></div>
<div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;  FD_SET(s, &amp;wds);</div>
<div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160; </div>
<div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;<span class="preprocessor">#ifdef WINDOWS</span></div>
<div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;  maxfd = s + 1;</div>
<div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160; </div>
<div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;  <span class="keywordflow">if</span> (timeout &gt; 0) {</div>
<div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;    ldiv_t d = ldiv(timeout * 1000, 1000000);</div>
<div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;    tv.tv_sec = d.quot;</div>
<div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;    tv.tv_usec = d.rem;</div>
<div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;  }</div>
<div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160; </div>
<div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;  <span class="comment">// Check for readability</span></div>
<div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;  <span class="keywordflow">return</span>(select(maxfd, NULL, &amp;wds, NULL, &amp;tv) &gt; 0);</div>
<div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;}</div>
<div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160; </div>
<div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160; </div>
<div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;int32 String::StartsWith(<span class="keyword">const</span> std::string &amp;s, <span class="keyword">const</span> std::string &amp;str) {</div>
<div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;  std::string::size_type pos = s.find_first_of(str);</div>
<div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;  <span class="keywordflow">if</span> (pos == 0)</div>
<div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;    <span class="keywordflow">return</span> 0;</div>
<div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;    <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;}</div>
<div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160; </div>
<div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;int32 String::EndsWith(<span class="keyword">const</span> std::string &amp;s, <span class="keyword">const</span> std::string &amp;str) {</div>
<div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;  std::string::size_type pos = s.find_last_of(str);</div>
<div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;  <span class="keywordflow">if</span> (pos == s.size() - str.size())</div>
<div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;    <span class="keywordflow">return</span> pos;</div>
<div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;  <span class="keywordflow">else</span></div>
<div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    <span class="keywordflow">return</span> -1;</div>
<div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;}</div>
<div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160; </div>
<div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;<span class="keywordtype">void</span> String::MakeUpper(std::string &amp;str)</div>
<div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;{</div>
<div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;  std::transform(str.begin(), str.end(), str.begin(), toupper);</div>
<div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;}</div>
<div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160; </div>
<div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;<span class="keywordtype">void</span> String::MakeLower(std::string &amp;str)</div>
<div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;{</div>
<div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;  std::transform(str.begin(), str.end(), str.begin(), tolower);</div>
<div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;}</div>
<div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160; </div>
<div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;<span class="keywordtype">void</span> String::Trim(std::string&amp; str, <span class="keyword">const</span> <span class="keywordtype">char</span>* chars2remove)</div>
<div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;{</div>
<div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;  TrimLeft(str, chars2remove);</div>
<div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;  TrimRight(str, chars2remove);</div>
<div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;}</div>
<div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160; </div>
<div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;<span class="keywordtype">void</span> String::TrimLeft(std::string&amp; str, <span class="keyword">const</span> <span class="keywordtype">char</span>* chars2remove)</div>
<div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;{</div>
<div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;  <span class="keywordflow">if</span> (!str.empty())</div>
<div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;  {</div>
<div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;    std::string::size_type pos = str.find_first_not_of(chars2remove);</div>
<div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160; </div>
<div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;    <span class="keywordflow">if</span> (pos != std::string::npos)</div>
<div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;      str.erase(0, pos);</div>
<div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;      str.erase(str.begin(), str.end()); <span class="comment">// make empty</span></div>
<div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;  }</div>
<div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;}</div>
<div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160; </div>
<div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;<span class="keywordtype">void</span> String::TrimRight(std::string&amp; str, <span class="keyword">const</span> <span class="keywordtype">char</span>* chars2remove)</div>
<div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;{</div>
<div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;  <span class="keywordflow">if</span> (!str.empty())</div>
<div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;  {</div>
<div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;    std::string::size_type pos = str.find_last_not_of(chars2remove);</div>
<div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160; </div>
<div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;    <span class="keywordflow">if</span> (pos != std::string::npos)</div>
<div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;      str.erase(pos + 1);</div>
<div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;      str.erase(str.begin(), str.end()); <span class="comment">// make empty</span></div>
<div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;  }</div>
<div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;}</div>
<div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160; </div>
<div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160; </div>
<div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;<span class="keywordtype">void</span> String::ReplaceLeading(std::string&amp; str, <span class="keyword">const</span> <span class="keywordtype">char</span>* chars2replace, <span class="keywordtype">char</span> c)</div>
<div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;{</div>
<div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;  <span class="keywordflow">if</span> (!str.empty())</div>
<div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;  {</div>
<div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;    std::string::size_type pos = str.find_first_not_of(chars2replace);</div>
<div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160; </div>
<div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;    <span class="keywordflow">if</span> (pos != std::string::npos)</div>
<div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;      str.replace(0, pos, pos, c);</div>
<div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;    <span class="keywordflow">else</span></div>
<div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;    {</div>
<div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;      <span class="keywordtype">int</span> n = str.size();</div>
<div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;      str.replace(str.begin(), str.end() - 1, n - 1, c);</div>
<div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;    }</div>
<div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;  }</div>
<div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;}</div>
<div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160; </div>
<div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160; </div>
<div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;int32 Random::r250_index_;</div>
<div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;int32 Random::r521_index_;</div>
<div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;uint32 Random::r250_buffer_[R250_LEN];</div>
<div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;uint32 Random::r521_buffer_[R521_LEN];</div>
<div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160; </div>
<div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="keywordtype">void</span> Random::Init() {</div>
<div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160; </div>
<div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;  int32 i = R521_LEN;</div>
<div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;  uint32 mask1 = 1;</div>
<div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;  uint32 mask2 = 0xFFFFFFFF;</div>
<div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160; </div>
<div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;  <span class="keywordflow">while</span> (i-- &gt; R250_LEN)</div>
<div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;    r521_buffer_[i] = rand();</div>
<div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;  <span class="keywordflow">while</span> (i-- &gt; 31) {</div>
<div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160; </div>
<div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;    r250_buffer_[i] = rand();</div>
<div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;    r521_buffer_[i] = rand();</div>
<div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;  }</div>
<div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160; </div>
<div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;  <span class="comment">// Establish linear independence of the bit columns</span></div>
<div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;  <span class="comment">// by setting the diagonal bits and clearing all bits above</span></div>
<div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;  <span class="keywordflow">while</span> (i-- &gt; 0) {</div>
<div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160; </div>
<div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;    r250_buffer_[i] = (rand() | mask1) &amp; mask2;</div>
<div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;    r521_buffer_[i] = (rand() | mask1) &amp; mask2;</div>
<div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;    mask2 ^= mask1;</div>
<div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;    mask1 &gt;&gt;= 1;</div>
<div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;  }</div>
<div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;  r250_buffer_[0] = mask1;</div>
<div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;  r521_buffer_[0] = mask2;</div>
<div class="line"><a name="l01159"></a><span class="lineno"> 1159</span>&#160;  r250_index_ = 0;</div>
<div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;  r521_index_ = 0;</div>
<div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;}</div>
<div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160; </div>
<div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;float32 Random::operator ()(uint32 range) {</div>
<div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;  <span class="comment">/*</span></div>
<div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;<span class="comment">  I prescale the indices by sizeof(unsigned long) to eliminate</span></div>
<div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;<span class="comment">  four shlwi instructions in the compiled code.  This minor optimization</span></div>
<div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;<span class="comment">  increased perf by about 12%.</span></div>
<div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;<span class="comment"></span> </div>
<div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;<span class="comment">  I also carefully arrange index increments and comparisons to minimize</span></div>
<div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;<span class="comment">  instructions.  gcc 3.3 seems a bit weak on instruction reordering. The</span></div>
<div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;<span class="comment">  j1/j2 branches are mispredicted, but nevertheless these optimizations</span></div>
<div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;<span class="comment">  increased perf by another 10%.</span></div>
<div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;<span class="comment">  */</span></div>
<div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160; </div>
<div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;  int32 i1 = r250_index_;</div>
<div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;  int32 i2 = r521_index_;</div>
<div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;  uint8 *b1 = (uint8 *)r250_buffer_;</div>
<div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;  uint8 *b2 = (uint8 *)r521_buffer_;</div>
<div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;  uint32 *tmp1, *tmp2;</div>
<div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;  uint32 r, s;</div>
<div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;  int32 j1, j2;</div>
<div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160; </div>
<div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;  j1 = i1 - R250_IB;</div>
<div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;  <span class="keywordflow">if</span> (j1 &lt; 0)</div>
<div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;    j1 = i1 + R250_IA;</div>
<div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;  j2 = i2 - R521_IB;</div>
<div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;  <span class="keywordflow">if</span> (j2 &lt; 0)</div>
<div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;    j2 = i2 + R521_IA;</div>
<div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160; </div>
<div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;  tmp1 = (uint32 *)(b1 + i1);</div>
<div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;  r = (*(uint32 *)(b1 + j1)) ^ (*tmp1);</div>
<div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;  *tmp1 = r;</div>
<div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;  tmp2 = (uint32 *)(b2 + i2);</div>
<div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;  s = (*(uint32 *)(b2 + j2)) ^ (*tmp2);</div>
<div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;  *tmp2 = s;</div>
<div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160; </div>
<div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;  i1 = (i1 != <span class="keyword">sizeof</span>(uint32)*(R250_LEN - 1)) ? (i1 + <span class="keyword">sizeof</span>(uint32)) : 0;</div>
<div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;  r250_index_ = i1;</div>
<div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;  i2 = (i2 != <span class="keyword">sizeof</span>(uint32)*(R521_LEN - 1)) ? (i2 + <span class="keyword">sizeof</span>(uint32)) : 0;</div>
<div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;  r521_index_ = i2;</div>
<div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160; </div>
<div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;  float32 _r = r ^ s;</div>
<div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;  <span class="comment">//return range*(_r/((float32)ULONG_MAX));</span></div>
<div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;  <span class="keywordflow">return</span> _r;</div>
<div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;}</div>
<div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.18
</small></address>
</body>
</html>
